<script>

//////////////////////////////
//
// DOMContentLoaded â€” page bootstrap
//

document.addEventListener("DOMContentLoaded", function () {

	// Audio end handling
	AUDIO = document.getElementById("audio");
	if (AUDIO) {
		AUDIO.addEventListener("ended", function () {
			AUDIO.pause();
			const pauseelem = document.getElementById(AUDIOid);
			if (pauseelem) pauseelem.className = "play";
		});
	}

	// Build filters
	buildComposerSelect();
	buildGenreSelect();
	buildVoiceSelect();
	createJoaJobLists();

	// Defaults
	if (typeof sessionStorage.REPERTOIREshowjrpid === "undefined") {
		sessionStorage.REPERTOIREshowjrpid = "false";
	}

	// Restore filters from URL or session
	const params = GetCgiParameters();

	const composers = document.getElementById("composers");
	const genres    = document.getElementById("genres");
	const voices    = document.getElementById("voices");
	const titlebox  = document.getElementById("titlebox");

	if (params.c) composers.value = params.c;
	else if (sessionStorage.REPERTOIREcomposers) composers.value = sessionStorage.REPERTOIREcomposers;

	if (params.g) genres.value = params.g;
	else if (sessionStorage.REPERTOIREgenres) genres.value = sessionStorage.REPERTOIREgenres;

	if (params.v) voices.value = params.v;
	else if (sessionStorage.REPERTOIREvoices) voices.value = sessionStorage.REPERTOIREvoices;

	if (params.t) titlebox.value = params.t;
	else if (sessionStorage.REPERTOIREtitlebox) titlebox.value = sessionStorage.REPERTOIREtitlebox;

	StylizeFormElements();

	// Decide initial view
	if (params.home === "true") {
		displayAboutRepertoire();
		return;
	}

	if (params.home === "census") {
		showCensusInfo();
		return;
	}

	// Default: show results
	repertoireDisplay(1);
});



//////////////////////////////
//
// Keyboard handling
//

window.addEventListener("keydown", function (event) {

	// Modifier tracking
	if (event.keyCode === ControlKey) ControlKeyState = 1;
	if (event.keyCode === ShiftKey)   ShiftKeyState   = 1;
	if (event.keyCode === AltKey)     AltKeyState     = 1;
	if (event.keyCode === CommandLeftKey || event.keyCode === CommandRightKey) {
		CommandKeyState = 1;
	}

	// Ignore command-key combos
	if (CommandKeyState) return;

	const titlebox = document.getElementById("titlebox");
	const inInput  = document.activeElement === titlebox;

	switch (event.keyCode) {

		case AKey:
			if (ControlKeyState) {
				sessionStorage.REPERTOIREpageview =
					(sessionStorage.REPERTOIREpageview === "all") ? "paged" : "all";
				repertoireDisplay(1);
			}
			break;

		case JKey:
			if (ControlKeyState) {
				sessionStorage.REPERTOIREshowjrpid =
					(sessionStorage.REPERTOIREshowjrpid === "true") ? "false" : "true";
				repertoireDisplay();
			}
			break;

		case RightArrowKey:
		case DownArrowKey:
			if (ControlKeyState || ShiftKeyState) displayNextPage();
			break;

		case LeftArrowKey:
		case UpArrowKey:
			if (ControlKeyState || ShiftKeyState) displayPreviousPage();
			break;

		case PageUpKey:   displayPreviousPage(); break;
		case PageDownKey: displayNextPage();     break;
		case HomeKey:     displayFirstPage();    break;
		case EndKey:      displayLastPage();     break;

		case EqualsKey:
			if (ControlKeyState) {
				sessionStorage.REPERTOIREpagesize =
					parseInt(sessionStorage.REPERTOIREpagesize || 20) + 1;
				displayFirstPage();
			}
			break;

		case MinusKey:
			if (ControlKeyState) {
				let v = parseInt(sessionStorage.REPERTOIREpagesize || 20);
				sessionStorage.REPERTOIREpagesize = Math.max(1, v - 1);
				displayFirstPage();
			}
			break;

		case BackspaceKey:
		case DeleteKey:
			if (ControlKeyState) {
				titlebox.value = "";
				repertoireDisplay(1);
			}
			break;

		case NKey:
			if (ControlKeyState) {
				CountInfo = !CountInfo;
				CountInfo ? showCountInfo() : hideCountInfo();
			}
			break;

		case TKey:
			if (ControlKeyState) {
				TextInfo = !TextInfo;
				repertoireDisplay();
			}
			break;
	}

	// Type-to-search (outside inputs)
	if (!inInput && !ControlKeyState && !AltKeyState && !CommandKeyState) {
		if (event.keyCode >= AKey && event.keyCode <= ZKey) {
			titlebox.value += String.fromCharCode(event.keyCode).toLowerCase();
			repertoireDisplay(1);
		}
	}
});



//////////////////////////////
//
// Key-up cleanup
//

window.addEventListener("keyup", function (event) {
	if (event.keyCode === ControlKey) ControlKeyState = 0;
	if (event.keyCode === ShiftKey)   ShiftKeyState   = 0;
	if (event.keyCode === AltKey)     AltKeyState     = 0;
	if (event.keyCode === CommandLeftKey || event.keyCode === CommandRightKey) {
		CommandKeyState = 0;
	}
});

</script>