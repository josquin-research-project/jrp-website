{% include_relative scripts-listeners.html %}

<script>
//
// Programmer:		Craig Stuart Sapp <craig@ccrma.stanford.edu>
// Creation Date: Thu Aug 21 12:59:01 PDT 2014
// Last Modified: Mon Oct 27 14:14:44 PDT 2014
// Filename:		.../repertoire/scripts-local.html
// Web Address:	https://josquin.stanford.edu/repertoire/scripts-local.html
// Syntax:			JavaScript 1.8/ECMAScript 5
// vim:				ts=3: ft=javascript: nowrap
//
// Description:	JavaScript management of the JRP Repertoire page.
//


//////////////////////////////
//
// migrateBrowseToRepertoire -- 
//

function migrateBrowseToRepertoire() {

	// nothing to migrate
	if (
		!localStorage.BROWSEcomposers &&
		!localStorage.BROWSEgenres &&
		!localStorage.BROWSEtitlebox
	) {
		return false;
	}

	sessionStorage.REPERTOIREcomposers = localStorage.BROWSEcomposers || "";
	sessionStorage.REPERTOIREgenres    = localStorage.BROWSEgenres    || "";
	sessionStorage.REPERTOIREtitlebox  = localStorage.BROWSEtitlebox  || "";

	// cleanup (critical)
	localStorage.removeItem("BROWSEhome");
	localStorage.removeItem("BROWSEcomposers");
	localStorage.removeItem("BROWSEgenres");
	localStorage.removeItem("BROWSEtitlebox");

	return true;
}

//////////////////////////////
//
// showRepertoireView -- View switcher
//

function showRepertoireView(view) {
  const views = {
    home: document.getElementById("repertoire-home"),
    results: document.getElementById("repertoire-results"),
    census: document.getElementById("repertoire-census")
  };

  Object.keys(views).forEach(v => {
    if (!views[v]) return;
    views[v].style.display = (v === view) ? "" : "none";
  });
}

//////////////////////////////
//
// browseFilter & renderBrowseResults -- Simple version of repertoire table
//


function browseFilter() {
  const composer = document.getElementById("composers")?.value || "";
  const genre    = document.getElementById("genres")?.value || "";
  const title    = normalize(document.getElementById("titlebox")?.value || "");

  return WORKS_INDEX.filter(w => {
    if (composer && !w.COMPOSER_ID.split(/\s*;\s*/).includes(composer)) {
		  return false;
		}
    if (genre && w.Genre !== genre) return false;
    if (title && !w._search.includes(title)) return false;
    return true;
  });
}

function renderBrowseResults() {
  const results = browseFilter();
  const target = document.getElementById("repertoire-results");

  if (!results.length) {
    target.innerHTML = "<p>No matches.</p>";
    return;
  }

  let html = `
    <table class="search-results-table">
      <thead>
        <tr>
          <th>Composer</th>
          <th>Title</th>
          <th>Genre</th>
          <th>Voices</th>
        </tr>
      </thead>
      <tbody>
  `;

  for (const w of results) {
	  html += `
	    <tr>
	      <td>${
				  w.COMPOSER_ID
				    .split(/\s*;\s*/)
				    .map(cid => COMPOSER_INDEX[cid]?.short)
				    .filter(Boolean)
				    .join("; ")
				}</td>
	      <td>
	        <a href="/work?id=${w.WORK_ID}">
	          ${w.Title}${w.Subtitle ? " â€“ " + w.Subtitle : ""}
	        </a>
	      </td>
	      <td>${w.Genre}</td>
	      <td>${w.Voices}</td>
	    </tr>
	  `;
	}

  html += "</tbody></table>";
  target.innerHTML = html;
}

//////////////////////////////
//
// removeHtmlAccents --
//

function removeHtmlAccents(str) {
	str = str.toLowerCase();
	if (!str.match(/&/)) {
		// No HTML entities, so don't bother trying to remove them.
		return str;
	}
	for (var i=0; i<HtmlAccentRemovalMap.length; i++) {
		str = str.replace(HtmlAccentRemovalMap[i].letters, 
				HtmlAccentRemovalMap[i].base);
	}
	return str;
}


//////////////////////////////
//
// resetFormValues -- Clear fields in Repertoire filter parameters.
//

function resetFormValues() {
	var composers = document.getElementById("composers");
	var genres    = document.getElementById("genres");
	var voices    = document.getElementById("voices");
	var titlebox  = document.getElementById("titlebox");

	composers.value = "";
	composers.label = "";
	genres.value    = "";
	genres.label    = "";
	voices.value    = "";
	voices.label    = "";
	titlebox.value  = "";
	titlebox.label  = "";

	sessionStorage.REPERTOIREcomposers = "";
	sessionStorage.REPERTOIREgenres    = "";
	sessionStorage.REPERTOIREvoices    = "";
	sessionStorage.REPERTOIREtitlebox  = "";

	StylizeFormElements();
}



//////////////////////////////
//
// showComposer -- Show all works for a particular composer.
//

function showComposer(repid) {
  const composers = document.getElementById("composers");
  const genres    = document.getElementById("genres");
  const voices    = document.getElementById("voices");
  const titlebox  = document.getElementById("titlebox");

  // Set composer filter
  composers.value = repid;
  composers.label = repid;

  // Clear others
  genres.value   = "";
  genres.label   = "";
  voices.value   = "";
  voices.label   = "";
  titlebox.value = "";
  titlebox.label = "";

  // Persist filters
  storeRepertoireFilters();

  // Show results, paged view
  sessionStorage.REPERTOIREpageview = "paged";
  showRepertoireView("results");

  // Render
  repertoireDisplay(1);

  // Optional: scroll to top
  window.scrollTo(0, 0);

  StylizeFormElements();
  return false;
}



//////////////////////////////
//
// showGenre -- Show all works in a particular genre.
//

function showGenre(genre) {
	var composers = document.getElementById("composers");
	composers.value = "";
	var genres = document.getElementById("genres");
	genres.value = genre;
	var voices = document.getElementById("voices");
	voices.value = "";
	var titlebox = document.getElementById("titlebox");
	titlebox.value = "";
	renderBrowseResults();
	showRepertoireView("results");
	$('html,body').scrollTop(0);
	StylizeFormElements();
}



function displayAboutRepertoire() {
	OnlyText = 0;
	showRepertoireView("home");
	resetFormValues();
	fillInAboutComposerList();
	showRepertoireHomeButton();
}


//////////////////////////////
//
// fillInAboutComposerList -- Dynamic version of the file
//	 includes/composer-repertoire-table.html.  This is a list
//	 of composers in the database and a count of how many
//	 works by them are present in the database.
//

function fillInAboutComposerList() {
  const list = document.getElementById("composer-repertoire-list");
  if (!list) return;

  InitializeWorklist();

  const columns = ["", ""];
  const colBounds = [
    { min: null, max: null },
    { min: null, max: null }
  ];

  const half = Math.ceil(WORKLIST.length / 2);

  for (let i = 0; i < WORKLIST.length; i++) {
    const entry   = WORKLIST[i];
    const repid   = entry.repid;
    const comlong = entry.comlong;
    const count   = entry.repwork;

    let comdates = entry.comdates || "";
    if (comdates) {
      comdates =
        ", <span style='font-size:90%; letter-spacing:-0.5px;'>" +
        comdates +
        "</span>";
    }

    const col = (i < half) ? 0 : 1;

    // Track first/last initial for column title
    const initial = comlong.trim().charAt(0).toUpperCase();
    if (!colBounds[col].min || initial < colBounds[col].min) {
      colBounds[col].min = initial;
    }
    if (!colBounds[col].max || initial > colBounds[col].max) {
      colBounds[col].max = initial;
    }

    columns[col] += "<li";

    if (entry.complete) {
		  columns[col] += " class='complete-composer'";
		}

    columns[col] += ">";
    columns[col] +=
      "<span onclick='showComposer(\"" + repid + "\");' " +
      "class='composer-link2'>" +
      comlong +
      "</span>" +
      comdates +
      " (" + count + (count === 1 ? " work" : " works") + ")";
    columns[col] += "</li>\n";
  }

  const title0 =
    colBounds[0].min && colBounds[0].max
      ? `${colBounds[0].min}&ndash;${colBounds[0].max}`
      : "";

  const title1 =
    colBounds[1].min && colBounds[1].max
      ? `${colBounds[1].min}&ndash;${colBounds[1].max}`
      : "";

  let output = "";
  output += `<div class="col">
<ul>
<li class="title">${title0}</li>
${columns[0]}
</ul>
</div>`;

  output += `<div class="col">
<ul>
<li class="title">${title1}</li>
${columns[1]}
</ul>
</div>`;

  ComposerList = output;
  list.innerHTML = output;
}


/////////////////////////////
//
// generateWorkEntries --
//

function generateWorkEntries(worklist) {
	var tout = [];
	var i;
	clearCountInfo();
	var composeroption = document.getElementById("composers").value;
	if (composeroption.match(/All/i)) {
		composeroption = "";
	}
	for (i=0; i<worklist.length; i++) {
		tout = tout.concat(generateComposerWorkEntries(worklist, i));
	}

	var output = [];
	for (i=0; i<tout.length; i++) {
		if (tout[i] == "") {
			continue;
		}
		output.push(tout[i]);
	}
	
	return output;
}



//////////////////////////////
//
// clearCountInfo --
//

function clearCountInfo() {
	WORKCOUNT = 0;
	WORKCOUNTBYCOMPOSER = {};
	COMPOSERALLWORKS = {};
}



//////////////////////////////
//
// generateComposerWorkEntries -- Do the main work of searching.
//
// Columns in table:
// (1) Genre
// (2) Composer
// (3) Title
// (4) Voices
// (5) Scores
// (6) MP3
//

function generateComposerWorkEntries(worklist, index) {
	var output			= [];
	var tempout			= "";
	var genre			= "";
	var voices			= "";
	var repid			= "";
	var title			= "";
	var fragment		= "";
	var searchtitle	= "";
	var titlelink		= "";
	var jrpid			= "";

	if (typeof worklist[index] !== 'undefined') {
		if (typeof worklist[index].comshort !== 'undefined') {
			composer = worklist[index].comshort;
			composer = composer.replace(/Comp&egrave;re/, "Compere");
			comshort = worklist[index].comshort;
		}
		if (typeof worklist[index].repid !== 'undefined') {
			repid  = worklist[index].repid;
		}
	}

	var entry;
	var j;
	var scorelink;
	var mp3link;

	var voiceoption    = document.getElementById("voices").value;
	// set voice option to two values for ranges of voices.
	var composeroption = document.getElementById("composers").value;
	var genreoption    = document.getElementById("genres").value;
	if (composeroption.match(/All/i)) {
		composeroption = "";
	}
	var titleboxoption    = document.getElementById("titlebox").value;
	titleboxoption = removeAccents(titleboxoption);
	// removing trailing space:
	titleboxoption = titleboxoption.replace(/\s+$/, "");
	// remove incomplete or search:
	titleboxoption = titleboxoption.replace(/\s*\bor?\b\s*$/, "");
	// convert "or" to "|":
	titleboxoption = titleboxoption.replace(/\s*\bor\b\s*/g, "|");
	// backslash causes problem in RegExp below, so remove it.
	titleboxoption = titleboxoption.replace(/\\/g, "");

	// only display desired composer(s):

	if (composeroption != "") {
		if ((typeof worklist[index] !== 'undefined') && 
				(composeroption != worklist[index].repid)) {
			return "";
		}
	}

	var tsearch = 0;
	if (!titleboxoption.match(/^\s$/)) {
		tsearch = 1;
	}
	var re = new RegExp(titleboxoption, "i")
	var attr;

	var voicemin;
	var voicemax;
	var temparr;
	var xcomposer = "";

	for (j=0; j<worklist[index].works.length; j++) {
		entry	   = worklist[index].works[j];
		attr	   = entry.attr     || '0';
		fragment = entry.fragment || 'false';
		genre	   = entry.genre    || '';
		voices	= entry.voices   || '?';
		const isTexted = entry.Texted === "yes" || entry.Texted === "Yes";
		
		if (OnlyText && !isTexted) {
			continue;
		}

    xcomposer = entry.composers || worklist[index].comshort;
    
   	switch (parseInt(entry.attr)) {
      	case 1: xcomposer += "<span onclick='window.location=\"/about/attribution\";' style='cursor:pointer; letter-spacing:-2px;'>&#10003;</span>"; break;
      	case 2: xcomposer += "<span onclick='window.location=\"/about/attribution\";' style='cursor:pointer; letter-spacing:-2px;'>(&#10003;)</span>"; break;
      	//case 2: xcomposer += "<sup onclick='window.location=\"/about/attribution\";' style='cursor:pointer; font-size:60%; letter-spacing:-1px;'>?</sup>"; break;
      	case 3: xcomposer += "<span onclick='window.location=\"/about/attribution\";' style='cursor:pointer; letter-spacing:-2px;'>(?)</span>"; break;
      	case 4: xcomposer += "<span onclick='window.location=\"/about/attribution\";' style='cursor:pointer;'>?</span>";   break;
      	case 5: xcomposer += "<span onclick='window.location=\"/about/attribution\";' style='cursor:pointer; letter-spacing:-2px;'>??</span>"; break;
      	case 6: xcomposer += "<span onclick='window.location=\"/about/attribution\";' style='cursor:pointer; letter-spacing:-2px;'>???</span>"; break;
   	}
		
		temparr = voices.match(/(\d+)[^\d]+(\d+)/);
		if ((temparr != null) && (temparr.length > 2)) {
			voicemin = parseInt(temparr[1]);
			voicemax = parseInt(temparr[2]);
			if (voicemin > voicemax) {
				var vtemp = voicemin;
				voicemin = voicemax;
				voicemax = vtemp;
			}
		} else if (voices.match(/(\d+)/)) {
			temparr  = voices.match(/(\d+)/);
			voicemin = temparr[1];
			voicemax = voicemin;
		} else {
			voicemin = 0;
			voicemax = 0;
		}
		
		title  = entry.title || "?";
		if (typeof entry.searchtitle === 'undefined') {
			if (typeof entry.title === 'undefined') {
				entry.searchtitle = "";
			} else {
				entry.searchtitle = removeHtmlAccents(entry.title);
			}
		}
		title = title.replace(/\(a\&/g, "(&agrave;&");
		jrpid  = entry.id	  || "";
		searchtitle  = jrpid + " " + (entry.searchtitle  || "");

		if (voiceoption != "") {
			var vo = parseInt(voiceoption);
			if (voices == voiceoption) {
				// matches literally so continue;
			} else if ((vo >= voicemin) && (vo <= voicemax)) {
				// voice range is ok.
			} else if ((voiceoption == "5+") && (voicemax >= 5)) {
				// also ok 
			} else if (voices != voiceoption) {
				continue;
			} else {
				console.log("GOT TO STRANGE VOICE CASE: " + voiceoption 
						+ ", " + voices);
				continue;
			}
		}

		if (genreoption != "") {
			if (genre.toLowerCase() != genreoption.toLowerCase()) {
				continue;
			}
		}

		if (tsearch) {
			var matches = searchtitle.match(re);
			if (!matches) {
				continue;
			}
		}

		// Work passed through the filters, so add it to the list.

		WORKCOUNT++;

		titlelink  = "<a style='word-spacing:1.5px; letter-spacing:-0.5px;' class='text-link' href='";
		titlelink += "/work?id=" + jrpid + "'>";
		titlelink += title + "</a>";
		if (fragment == true) {
			titlelink += " <span style=\"font-size:90%; letter-spacing:-0.5px;\">[fragment]</span>";
		}

		scorelink  = "<a class='file' target='" + PDFTARGET + "' title='Score without editorial";
		scorelink += " accidentals' href='{{site.jrp-data-url}}";
		scorelink += "?a=notationNoEditWithText&f=" + jrpid + "'>file</a>";

		scorelink += "<a title='Score with editorial accidentals'";
		scorelink += " class='file-ed' target='" + PDFTARGET + "' href='{{site.jrp-data-url}}";
		scorelink += "?a=notationWithEditWithText&f=" + jrpid;
		scorelink += "'>Ed.&nbsp;file</a> ";

		//mp3link	 = "<a class='play' target='_blank' href='{{site.jrp-data-url}}";
		//mp3link	+= "?a=mp3&f=" + jrpid + "'>play</a>";

	   if (AUDIOjrpid == jrpid) {
			mp3link = "<a id=\"audio_" + jrpid + "\" ";
			mp3link += "name=\"\" style=\"cursor:hand; cursor:pointer;\" ";
			mp3link += "onclick=\"PlayAudioFile('" + jrpid + "', this);\" ";
			mp3link += "class=\"pause\">play</a>";
		} else {
			mp3link = "<a id=\"audio_" + jrpid + "\" ";
			mp3link += "name=\"\" style=\"cursor:hand; cursor:pointer;\" ";
			mp3link += "onclick=\"PlayAudioFile('" + jrpid + "', this);\" ";
			mp3link += "class=\"play\">play</a>";
		}

		tempout = "<tr>";
			jrpid  = entry.id	  || "";

		if (TextInfo && isTexted) {
			//tempout	 = "<tr valign=top><td style=\"background-color:#eeeeee;\">" + genre;
			if (sessionStorage.REPERTOIREshowjrpid == "true") {
				tempout    += "<td style=\"background-color:#eeeeee;\">" + jrpid;
			} else {
				tempout    += "<td style=\"background-color:#eeeeee;\">" + genre;
			}
		} else {
			//tempout	 = "<tr valign=top><td>" + genre;
			if (sessionStorage.REPERTOIREshowjrpid == "true") {
				tempout    += "<td>" + jrpid;
			} else {
				tempout    += "<td>" + genre;
			}
		}

		tempout	+= "</td><td>" + xcomposer;
		tempout	+= "</td><td style='text-indent:-12px;'>" + titlelink;
		tempout	+= "</td><td>" + voices;
		tempout	+= "</td><td>" + scorelink;
		tempout	+= "</td><td>" + mp3link;
		tempout	+= "</tr>\n";

		output.push(tempout);
	}

	return output;
}

//////////////////////////////
//
// repertoireDisplay -- display works of one or more composer.
//
//
//

function repertoireDisplayTitleBox(page) {
	// This is needed to avoid problems with shift-arrow keys.
	// Need to also check if the key pressed is an arrow key, but
	// this is close enough for now.
	if (ShiftKeyState || ControlKeyState) {
		return;
	}
	repertoireDisplay(page);
}


function repertoireDisplay(page) {

  // Default to paged view (not "all")
  if (sessionStorage.REPERTOIREpageview !== "all") {
		sessionStorage.REPERTOIREpageview = "paged";
	}

  if (typeof page === 'undefined') {
    page = sessionStorage.REPERTOIREcurrentpage;
  }

	storeRepertoireFilters();
	showRepertoireHomeButton();
	showRepertoireView("results");
	
	var maincontent = document.getElementById('repertoire-results');
	var content = "";
	content += printTableStart();
	InitializeWorklist();

	var tablerows = generateWorkEntries(WORKLIST);
	if (typeof sessionStorage.REPERTOIREpagesize === 'undefined') {
		sessionStorage.REPERTOIREpagesize = 20;
	}
	if (typeof sessionStorage.REPERTOIREpagesize === 'undefined') {
		sessionStorage.REPERTOIREshowjrpid = "false";
	}
	var pagesize = sessionStorage.REPERTOIREpagesize;
	sessionStorage.REPERTOIREentries = tablerows.length;
	var totalpages = tablerows.length / pagesize;
	if (totalpages - parseInt(totalpages) > 0.0) {
		totalpages = parseInt(totalpages) + 1;
	} else {
		totalpages = parseInt(totalpages);
	}
	if (page < 1) {
		page = 1;
	}
	if (page > totalpages) {
		page = totalpages;
	}
	sessionStorage.REPERTOIREcurrentpage = page;

	var startindex = (page - 1) * pagesize;
	var stopindex  = parseInt(startindex) + parseInt(pagesize);
	if (stopindex > tablerows.length) {
		stopindex = tablerows.length;
	}

	if (sessionStorage.REPERTOIREpageview == "all") {
		startindex = 0;
		stopindex = tablerows.length;
	}

	var tablebody = "";
	var i;
	if (tablerows.length > 0) {
		for (i=startindex; i<stopindex; i++) {
			tablebody += tablerows[i];
		}
	}
	content += tablebody;
	content += printTableEnd();
	maincontent.innerHTML = content;

	printPageList(page, totalpages);

	if (CountInfo) {
		showCountInfo();
	}
}



//////////////////////////////
//
// printTableEnd --
//

function printTableEnd() {
	return "</tbody>\n</table>\n</div>\n";
}



//////////////////////////////
//
// printPageList --
//
//  <span id="page-list">
//	<ul>
//	 <li class="active"><a href="#">&lt;</a></li>
//	 <li class="active"><a href="#">1</a></li>
//	 <li><a href="#">2</a></li>
//	  <li><a href="#">...</a></li>
//	 <li><a href="#">10</a></li>
//	 <li><a href="#">20</a></li>
//	 <li><a href="#">&gt;</a></li>
//	 <li><a href="#">view all</a></li>
//	</ul>
//  </span>
//

function printPageList(currentpage, totalpages) {

	var rightarrow = "&#10095;";
	// var rightarrow = "&gt;";
	var leftarrow = "&#10094;";
	// var leftarrow = "&lt;";

	if (sessionStorage.REPERTOIREpageview == "all") {
		printPageListAll(totalpages);
		return;
	}
 
	var pagelist = document.getElementById("page-list");
	if (totalpages <= 1) {
		pagelist.innerHTML = "<ul><li>&nbsp;</ul>";
		return;
	}

	var output = "<ul>\n";

	previouspage = currentpage - 1;
	if (previouspage < 1) {
		previouspage = totalpages;
	}

	// print left arrow 
	output += "<li><span style=\"cursor:hand; cursor:pointer;\"";
	output += " onclick=\"repertoireDisplay(";
	output += previouspage;
	output += ");\">";
	output += leftarrow + "</span></li>\n";

	// print the number one:
	if (currentpage == 1) {
		output += "<li class=\"active\">1</li>\n";
	} else {
		output += "<li><span style=\"cursor:hand; cursor:pointer;\"";
		output += " onclick=\"repertoireDisplay(1);\">";
		output += "1</span></li>\n";
	}

	if (totalpages > 2) {

		var elipsis = "&#8943;";
		var needpredots = 0;
		var needpostdots = 0;
		if (totalpages > 3) {
			if (currentpage > 2) {
				needpredots = 1;
			}
			if (currentpage < totalpages - 1) {
				needpostdots = 1;
			}
		} else if ((totalpages == 3) && (currentpage != 2)) {
			if (currentpage == 1) {
				needpostdots = 1;
			} else {
				needpredots = 1;
			}
		}
	
		if (needpredots) {
			output += "<li><span style=\"cursor:hand; cursor:pointer;\"";
			output += " onclick=\"repertoireDisplay(";
			output += (currentpage - 1) + ");\">";
			output += elipsis + "</span></li>\n";
		}
	
		if ((currentpage > 1) && (currentpage < totalpages)) {
			output += "<li class=\"active\">" + currentpage + "</li>\n";
		}
	
		if (needpostdots) {
			output += "<li><span style=\"cursor:hand; cursor:pointer;\"";
			output += " onclick=\"repertoireDisplay(";
			output += (currentpage + 1) + ");\">";
			output += elipsis + "</span></li>\n";
		}
	}

	// print the last page:
	if (currentpage == totalpages) {
		output += "<li class=\"active\">" + currentpage + "</li>\n";
	} else {
		output += "<li><span style=\"cursor:hand; cursor:pointer;\"";
		output += " onclick=\"repertoireDisplay(";
		output += totalpages;
		output += ");\">";
		output += totalpages + "</span></li>\n";
	}

	var nextpage = currentpage + 1;
	if (nextpage > totalpages) {
		nextpage = 1;
	}

	// print right arrow gray if on page one otherwise blue.
	output += "<li><span style=\"cursor:hand; cursor:pointer;\"";
	output += " onclick=\"repertoireDisplay(";
	output += nextpage + ");\">";
	output += rightarrow + "</span></li>\n";

	output += "<li>";
	output += "<span style=\"cursor:hand; cursor:pointer;";
	output += " letter-spacing:=-0.5px;\"";
	output += " onclick=\"sessionStorage.REPERTOIREpageview='all';";
	output += " repertoireDisplay(1);\">view all</span>";
	output += "</li>\n";

	output += "</ul>\n";
	pagelist.innerHTML = output;
}



/////////////////////////////
//
// printPageListAll --
//

function printPageListAll(totalpages) {
	var output = "";

	if (totalpages == 1) {
		// don't show "paged view" option if there would only be one page
		// in paged view.
		output += "<ul><li>&nbsp;</li></ul>";
		document.getElementById("page-list").innerHTML = output;
		return;
	}

	output += "<ul><li>";
	output += "<span style=\"cursor:hand; cursor:pointer;";
	output += " letter-spacing:-0.5px;\"";
	output += " onclick=\"sessionStorage.REPERTOIREpageview='paged';";
	output += " repertoireDisplay(1);\">paged view</span>";
	output += "</li></ul>\n";

	document.getElementById("page-list").innerHTML = output;
}



//////////////////////////////
//
// printTableStart --
//

function printTableStart() {
	var output = "";

	output += "<div class='search-results-content'>\n";

	output += "<div class=\"pagination\">\n";
	output += "<span id=\"match-counts\" class=\"grey\"></span>\n";
	output += "<span class=\"pagination\" id=\"page-list\"></span>\n";
	output += "</div>\n";

	output += "<table style='margin-bottom:48px;' ";
	output += "class='search-results-table'>\n";
	output += "<thead>\n";
	output += "<tr>\n";

	if (sessionStorage.REPERTOIREshowjrpid == "true") {
		output += "<th class='sortable'><a href='#'>JRPID</a></th>\n";
	} else {
		output += "<th class='sortable'><a href='#'>Genre</a></th>\n";
	}

	output += "<th class='sortable'><a href='#'><span style='margin-left:-30px;'>Composer</span></a></th>\n";
	output += "<th class='sortable'><a href='#'><span style='margin-left:-25px;'>Title</span></a></th>\n";
	output += "<th>Voices</th>\n";
	output += "<th>Scores</th>\n";
	output += "<th>MP3</th>\n";
	output += "</tr>\n";
	output += "</thead>\n";
	output += "<tbody>\n";
	return output;
}



//////////////////////////////
//
// displayNextPage --
//

function displayNextPage() {
	var currentpage = sessionStorage.REPERTOIREcurrentpage;
	var nextpage = parseInt(currentpage) + 1;
	var pagecount = sessionStorage.REPERTOIREentries / sessionStorage.REPERTOIREpagesize;
	if (pagecount - parseInt(pagecount) > 0) {
		pagecount = parseInt(pagecount) + 1;
	} else {
		pagecount = parseInt(pagecount);
	}
	if (nextpage > pagecount) {
		nextpage = 1;
	}
	repertoireDisplay(nextpage);
}



//////////////////////////////
//
// displayPreviousPage --
//

function displayPreviousPage() {
	var currentpage = sessionStorage.REPERTOIREcurrentpage;
	var previouspage = parseInt(currentpage) - 1;
	var pagecount = sessionStorage.REPERTOIREentries / sessionStorage.REPERTOIREpagesize;
	if ((pagecount - parseInt(pagecount)) > 0) {
		pagecount = parseInt(pagecount) + 1;
	} else {
		pagecount = parseInt(pagecount);
	}
	if (previouspage < 1) {
		previouspage = pagecount;
	}
	repertoireDisplay(previouspage);
}



//////////////////////////////
//
// displayFirstPage --
//

function displayFirstPage() {
	repertoireDisplay(1);
}



//////////////////////////////
//
// displayLastPage --
//

function displayLastPage() {
	var pagecount = sessionStorage.REPERTOIREentries / sessionStorage.REPERTOIREpagesize;
	if (pagecount - parseInt(pagecount) > 0) {
		pagecount = parseInt(pagecount) + 1;
	} else {
		pagecount = parseInt(pagecount);
	}
	repertoireDisplay(pagecount);
}



//////////////////////////////
//
// showCountInfo --
//

function showCountInfo() {
	var countinfo = document.getElementById('countinfo');
	if (countinfo == null) {
		return;
	}
	var message = WORKCOUNT;
	if (WORKCOUNT == 1) {
		message += " work";
	} else {
		message += " works";
	}
	message += "<table>\n";
	var composeroption = document.getElementById('composers').value;
	if (composeroption.match(/All/i)) {
		composeroption = "";
	}
	if (composeroption.match(/^\s*$/)) {
		for (var key in WORKCOUNTBYCOMPOSER) {
			if (WORKCOUNTBYCOMPOSER[key] == 0) {
				continue;
			}
			message += "<tr><td style='padding-right:30px;'>" + key + ": </td>";
			message += "<td valign=right>";
			message += WORKCOUNTBYCOMPOSER[key];
			if (COMPOSERALLWORKS[key] != WORKCOUNTBYCOMPOSER[key]) {
				message += "/" + COMPOSERALLWORKS[key];
			}
			message += "</td></tr>\n";
		}
		message += "</table>\n";
	}
	message += "<div style='min-height:24px;'></div>\n";
	
	countinfo.innerHTML = message;
}



//////////////////////////////
//
// hideCountInfo --
//

function hideCountInfo() {
	var countinfo = document.getElementById('countinfo');
	if (countinfo == null) {
		return;
	}
	countinfo.innerHTML = '';
}



//////////////////////////////
//
// repertoireDisplayAll --
//

function repertoireDisplayAll() {
  clearRepertoireFilters();
  OnlyText = 0;

  // default to paged view
  sessionStorage.REPERTOIREpageview = "paged";

  showRepertoireView("results");
  repertoireDisplay(1);
  window.scrollTo(0, 0);
}

//////////////////////////////
//
// showAllTextedWorks --
//

function showAllTextedWorks() {
	clearRepertoireFilters();
	OnlyText = 1;
	
	// default to paged view
  sessionStorage.REPERTOIREpageview = "paged";


	showRepertoireView("results");
	repertoireDisplay(1);
	window.scrollTo(0, 0);
}


//////////////////////////////
//
// clearRepertoireFilters -- Set repertoire filters to defaults or empty.
//

function clearRepertoireFilters() {
	document.getElementById("genres").value = "";
	document.getElementById("voices").value = "";
	document.getElementById("composers").value = "";
	document.getElementById("titlebox").value = "";

	sessionStorage.REPERTOIREcomposers = "";
	sessionStorage.REPERTOIREgenres    = "";
	sessionStorage.REPERTOIREvoices    = "";
	sessionStorage.REPERTOIREtitlebox  = "";

	StylizeFormElements();
}



//////////////////////////////
//
// storeRepertoireFilters --
//

function storeRepertoireFilters() {
	sessionStorage.REPERTOIREcomposers = document.getElementById("composers").value;
	sessionStorage.REPERTOIREgenres    = document.getElementById("genres").value;
	sessionStorage.REPERTOIREvoices    = document.getElementById("voices").value;
	sessionStorage.REPERTOIREtitlebox  = document.getElementById("titlebox").value;

	if (sessionStorage.REPERTOIREcomposers.match(/All/i)) {
		sessionStorage.REPERTOIREcomposers = "";
	}
	if (sessionStorage.REPERTOIREgenres.match(/All/i)) {
		sessionStorage.REPERTOIREgenres = "";
	}

}



//////////////////////////////
//
// buildComposerSelect -- Create the Composer drop-down list for browsing.
//

function buildComposerSelect() {
	var composerselect = document.getElementById("composers-select");
	if (composerselect == null) {
		return;
	}

	var output = "<select id=\"composers\"";
	output += " onchange=\"repertoireDisplay();\"";
	output += " data-placeholder=\"All Composers\">\n";
	output += "<option value=\"\" label=\"All Composers\">All Composers</option>\n";
	var clist = GetComposerOptions(WORKS_INDEX);
	output += clist;
	output += "</select>\n";
	composerselect.innerHTML = output;

	StylizeFormElements();
}



//////////////////////////////
//
// buildGenreSelect -- Create the Genre drop-down list for browsing.
//

function buildGenreSelect() {
	var genreselect = document.getElementById("genres-select");
	if (genreselect == null) {
		return;
	}

	var output = "<select id=\"genres\"";
	output += " onchange=\"repertoireDisplay();\"";
	output += " data-placeholder=\"All Genres\">\n";
	output += "<option value=\"\" label=\"default\">All Genres</option>\n";
	var clist = GetGenreBrowseOptions();
	output += clist;
	output += "</select>\n";
	genreselect.innerHTML = output;

	StylizeFormElements();
}



//////////////////////////////
//
// buildVoiceSelect -- Create the Voice drop-down list for browsing.
//

function buildVoiceSelect() {
	var genreselect = document.getElementById("voices-select");
	if (genreselect == null) {
		return;
	}

	var output = "<select id=\"voices\"";
	output += " onchange=\"repertoireDisplay();\"";
	output += " data-placeholder=\"All Composers\">\n";
	output += "<option value=\"\" label=\"default\">All Voices</option>\n";
	var clist = GetVoiceOptions();
	output += clist;
	output += "</select>\n";
	genreselect.innerHTML = output;

	StylizeFormElements();
}



/////////////////////////////
//
// showCensusInfo --
//

function showCensusInfo() {
	var content = '';
	content += '<section style="font-size:100%; padding-left:8px; ';
	content += 'padding-right:0px; padding-bottom:100px;" ';
	content += 'id="repertoire-home" class="repertoire-content">\n';
	content += '<article style="padding-left:10px; padding-right:0px;" class="about first">\n';
	content += '<h2 class="brown-heading">Census of work and note ';
	content += 'counts by composer/genre</h2>\n';
	content += '<div id="notetable"></div>\n';
	content += '</article>\n';
	content += '\n';
	content += '<article style="padding-left:10px; padding-right:0;" class="about first">\n';
	content += '<h2 class="brown-heading">Nominal performance durations ';
	content += 'by composer/genre</h2>\n';
	content += '<div id="timetable"></div>\n';
	content += '</article>\n';
	content += '\n';
	content += '<article style="padding-left:10px;" ';
	content += 'style="margin-bottom:90px;" class="about first">\n';
	content += '<h2 class="brown-heading">PDF page counts ';
	content += 'by composer/genre</h2>\n';
	content += '<div id="pagetable"></div>\n';
	content += '</article>\n';
	content += '</section>\n';
	var element = document.getElementById("repertoire-census");
	element.innerHTML = content;
	showRepertoireView("census");
	showNoteTable("notetable");
	showTimeTable("timetable");
	showPageTable("pagetable");
	var i;

	// Convert composer anchor tags pointing pointing to an external page into
	// events which move within the page:
   var composerlinks = document.querySelectorAll("table.census td a");
	var newlink;
	var matches;
	var title;
   var dummy = document.createElement("div");
	for (i=0; i<composerlinks.length; i++) {
		dummy.innerHTML = "";
		dummy.appendChild(composerlinks[i].cloneNode(true));
		matches = dummy.innerHTML.match(/c=([A-Z][a-z][a-z])/);
		if (!matches) {
			continue;
		}
		title = composerlinks[i].getAttribute("title");
		newlink  = '<span class="text-link" title="' + title + '"';
      newlink += ' onclick="showComposer(\'' + matches[1] + '\');"';
		newlink += '>' + composerlinks[i].textContent + '</span>';
		composerlinks[i].outerHTML = newlink;
	}

	var tables = document.querySelectorAll("table.census");
	var width = $('#repertoire-home').width();
	for (i=0; i<tables.length; i++) {
		tables[i].style.width = width + 'px';
	}

	showRepertoireHomeButton();

}


//////////////////////////////
//
// showRepertoireHomeButton --
//

function showRepertoireHomeButton() {
	var text = '<span style="cursor:hand; cursor:pointer;" ';
	text += 'onclick="displayAboutRepertoire();" class="btn btn-brown">';
	if (window.location.pathname.match(/performance/i)) {
		text += 'Performance Home';
	} else {
		text += 'Repertoire Home';
	}
	text += '</span>\n';
	document.getElementById('about-button').innerHTML = text;
}

</script>