<script>
let JRP = {};
let WORKS = {% include metadata/works.json %};

//////////////////////////////
//
// initializeHomepage -- shared init logic
//

function initializeHomepage(worklist) {
	if (!Array.isArray(worklist) || worklist.length === 0) {
		console.warn("initializeHomepage: empty worklist");
		return;
	}

	JRP.WORKS = worklist;

	buildHomepageComposerSelect(JRP.WORKS);
	buildHomepageGenreSelect();

	if (document.getElementById("sample-music")) {
		displayRandomExample(JRP.WORKS);
	}

	if (document.getElementById("recently-added")) {
		displayRecentAdditions(7, JRP.WORKS);
	}
}



//////////////////////////////
//
// DOMContentLoaded event listener
//

document.addEventListener("DOMContentLoaded", function () {

	// Audio handling
	const AUDIO = document.getElementById("audio");
	if (AUDIO) {
		AUDIO.addEventListener("ended", function () {
			AUDIO.pause();
			if (window.AUDIOid) {
				const pauseelem = document.getElementById(AUDIOid);
				if (pauseelem) pauseelem.className = "play";
			}
		});
	}

	sessionStorage.removeItem("RECENTLYADDEDHTML");

	// ----------------------------------
	// 1) Prefer local works.json
	// ----------------------------------
	if (Array.isArray(WORKS) && WORKS.length > 0) {
		console.log("Using local works.json");
		initializeHomepage(WORKS);
		return;
	}

	// ----------------------------------
	// 2) Fallback: fetch Google Sheet
	// ----------------------------------
	console.warn("Local works.json unavailable, fetching remote data");

	const macroid = "AKfycbyeHfmyCHHgbY9X_UDMzW9xyRgqH0c7Ycp76NTW18mjZSnW_2umhgH2ZGDtxuwDot6mKw";
	let url = `https://script.google.com/macros/s/${macroid}/exec`;
	url += "?sheet=works&format=json";

	fetch(url)
		.then(response => {
			if (!response.ok) {
				throw new Error("Request failed with status " + response.status);
			}
			return response.json();
		})
		.then(data => {
			initializeHomepage(data);
		})
		.catch(error => {
			console.error("Homepage initialization failed:", error);
		});

	const titlebox = document.getElementById("titlebox");
	if (titlebox) {
		titlebox.addEventListener("keydown", function (e) {
			if (e.key === "Enter") {
				e.preventDefault();
				storeBrowseParameters();
			}
		});
	}

});
</script>